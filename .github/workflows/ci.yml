# =============================================================================
# GITHUB ACTIONS - WORKFLOW CI (Continuous Integration)
# =============================================================================
# Ce fichier est lu automatiquement par GitHub √† chaque push/PR
# Il d√©finit les "jobs" (t√¢ches) √† ex√©cuter
# =============================================================================

# Nom du workflow (affich√© dans l'onglet Actions de GitHub)
name: CI - Tests & Linting

# =============================================================================
# QUAND d√©clencher ce workflow ?
# =============================================================================
on:
  # √Ä chaque push sur la branche master
  push:
    branches: [ master ]
  
  # √Ä chaque Pull Request vers master
  pull_request:
    branches: [ master ]

# =============================================================================
# LES JOBS (t√¢ches √† ex√©cuter)
# =============================================================================
jobs:

  # ---------------------------------------------------------------------------
  # JOB 1 : Tester le Backend Django
  # ---------------------------------------------------------------------------
  test-backend:
    # Sur quelle machine virtuelle ex√©cuter ?
    runs-on: ubuntu-latest
    
    # Variables d'environnement pour ce job
    env:
      DJANGO_SECRET_KEY: 'test-secret-key-for-ci'
      DJANGO_DEBUG: 'True'
      DJANGO_ALLOWED_HOSTS: 'localhost,127.0.0.1'
    
    # Les √©tapes du job (ex√©cut√©es dans l'ordre)
    steps:
      # √âtape 1 : R√©cup√©rer le code du repo
      - name: üì• Checkout code
        uses: actions/checkout@v4
        # Explication : GitHub Actions part d'une machine vide
        # Il faut d'abord "cloner" ton repo sur cette machine
      
      # √âtape 2 : Installer Python
      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          # Cache pip pour acc√©l√©rer les prochains builds
          cache: 'pip'
          cache-dependency-path: 'back_dango/requirements.txt'
      
      # √âtape 3 : Installer les d√©pendances Python
      - name: üì¶ Install dependencies
        run: |
          cd back_dango
          python -m pip install --upgrade pip
          pip install -r requirements.txt
        # "run" ex√©cute des commandes shell (comme dans ton terminal)
      
      # √âtape 4 : V√©rifier la syntaxe Python (linting)
      - name: üîç Check Python syntax
        run: |
          pip install flake8
          cd back_dango/src
          # V√©rifier les erreurs de syntaxe (ignore les warnings de style)
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
      
      # √âtape 5 : Lancer les tests Django
      - name: üß™ Run Django tests
        run: |
          cd back_dango/src
          python manage.py test --verbosity=2
        # --verbosity=2 affiche plus de d√©tails sur les tests

  # ---------------------------------------------------------------------------
  # JOB 2 : Tester le Frontend Angular
  # ---------------------------------------------------------------------------
  test-frontend:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
      
      # Installer Node.js
      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'front_angular/package-lock.json'
      
      # Installer les d√©pendances npm
      - name: üì¶ Install dependencies
        run: |
          cd front_angular
          npm ci
        # "npm ci" est plus rapide que "npm install" en CI
        # Il utilise exactement les versions du package-lock.json
      
      # V√©rifier que le build passe
      - name: üî® Build Angular
        run: |
          cd front_angular
          npm run build
        # Si le build √©choue, le workflow √©choue aussi

  # ---------------------------------------------------------------------------
  # JOB 3 : Message de succ√®s (optionnel)
  # ---------------------------------------------------------------------------
  success-message:
    # Ce job ne s'ex√©cute QUE si les deux autres ont r√©ussi
    needs: [test-backend, test-frontend]
    runs-on: ubuntu-latest
    
    steps:
      - name: ‚úÖ All tests passed!
        run: echo "üéâ Backend and Frontend tests passed successfully!"
